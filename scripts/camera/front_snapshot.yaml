sequence:
  - service: notify.logfile
    data:
      message: "Snapshotting front camera"
  - service: camera.snapshot
    data_template:
      entity_id: camera.front_camera
      filename: "/data/homeassistant/cameras/front_camera_snapshot.jpg"
  - service: notify.logfile
    data:
      message: "Scanning with Doods"
  - service: image_processing.scan
    entity_id: image_processing.doods_front_camera
  - service: notify.logfile
    data:
      message: "Waiting for Doods"
  # Wait for Doods to finish processing
  - wait_template: >-
      {{ 0 < ((as_timestamp(now()) - as_timestamp(states.image_processing.doods_front_camera.last_updated)) < 2 ) }}
    timeout: 10
    continue_on_timeout: true
  - service: notify.logfile
    data:
      message: "Notifying"
  - service: notify.discord
    data_template:
      message: >-
        There was motion at the front at {{ as_timestamp(states.input_boolean.front_camera_motion.last_updated)|timestamp_custom('%F %T', True) }}. We found 
        {%- if "person" in state_attr('image_processing.doods_front_camera','matches') %}
          {{ state_attr('image_processing.doods_front_camera','summary').person }} people ({%- for state in state_attr('image_processing.doods_front_camera','matches').person %}{{ state.score|round(0) }}% at {{state.box}}{%- if loop.last %}{% else %}, {% endif %}{% endfor %})
        {% endif %}
        {%- if "car" in state_attr('image_processing.doods_front_camera','matches') %}
          {{ state_attr('image_processing.doods_front_camera','summary').car }} car(s) ({%- for state in state_attr('image_processing.doods_front_camera','matches').car %}{{ state.score|round(0) }}% at {{state.box}} {{ "Ignore" if (0.7260 < state.box[0] < 0.7330) and (0.4440 < state.box[1] < 0.4500) and (0.8345 < state.box[2] < 0.8375) and (0.5748 < state.box[3] < 0.5780) else "Valid" }}{%- if loop.last %}{% else %}, {% endif %}{% endfor %})
        {% endif %}
        {%- if "truck" in state_attr('image_processing.doods_front_camera','matches') %}
          {{ state_attr('image_processing.doods_front_camera','summary').truck }} truck(s) ({%- for state in state_attr('image_processing.doods_front_camera','matches').truck %}{{ state.score|round(0) }}%{%- if loop.last %}{% else %}, {% endif %}{% endfor %})
        {% endif %}
        {%- if "motorcycle" in state_attr('image_processing.doods_front_camera','matches') %}
          {{ state_attr('image_processing.doods_front_camera','summary').motorcycle }} motorcycle(s) ({%- for state in state_attr('image_processing.doods_front_camera','matches').motorcycle %}{{ state.score|round(0) }}%{%- if loop.last %}{% else %}, {% endif %}{% endfor %})
        {% endif %}
        {%- if "bicycle" in state_attr('image_processing.doods_front_camera','matches') %}
          {{ state_attr('image_processing.doods_front_camera','summary').bicycle }} bicycle(s) ({%- for state in state_attr('image_processing.doods_front_camera','matches').bicycle %}{{ state.score|round(0) }}%{%- if loop.last %}{% else %}, {% endif %}{% endfor %})
        {% endif %}
      target: !secret discord_camera_channel
      data:
        images:
        - "/data/homeassistant/cameras/front_camera_snapshot.jpg"
        - "/data/homeassistant/cameras/front_camera_latest.jpg"
  - service: notify.logfile
    data:
      message: "Done"
